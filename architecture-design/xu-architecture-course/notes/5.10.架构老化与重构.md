# 架构老化与重构

原文链接：[66 | 架构老化与重构 (geekbang.org)](https://time.geekbang.org/column/article/180396)

架构老化源于什么？

在我们不断给系统添加各种新功能的时候，往往会遇到功能需求的实现方式不在当初框架设定的范围之内，于是很多功能代码逸出框架的范围之外。

这些散落在各处的代码，把系统绞得支离破碎。久而久之，代码就出现老化，散发出臭味。

代码老化的标志，是添加功能越来越难，迭代效率降低，问题却是持续不断，解决了一个问题却又由此生出好几个新问题。

在理想的情况下，如果我们坚持以 “最小化的核心系统 + 多个相互正交的周边系统” 这个指导思想来构建应用，那么代码就很难出现老化。当然，这毕竟是理想情况。现实情况下，有很多原因会导致架构老化难以避免，比如：

- 软件工程师的技术能力不行，以功能完成为先，不考虑项目的长期维护成本；
- 公司缺乏架构评审环节，系统的代码质量缺乏持续有效的关注；
- 需求理解不深刻，最初架构设计无法满足迭代发展的需要；
- 架构迭代不及时，大量因为赶时间而诞生的补丁式代码；
- ......



那么，怎么应对架构老化？

这个问题可以从两个视角来看：

- 该怎么重构系统，才能让我们的软件重新恢复活力？
- 在重构系统之前，我们应该如何进行局部改善，如果增加新功能又应该如何考虑？

## 老系统怎么添加新功能

先说说添加新功能。

正常来说，我们添加功能的时候，尤其是自己加入项目组比较晚，已经有大量的历史代码沉淀在那里的时候，通常我们应该把自己要添加的功能定位为周边功能。对于周边功能，往往考虑最多的点是如何少给核心系统添加麻烦，能够少改就少改。

但是，这其实还不够。实际上当我们视角放在周边系统的时候，其实它本身也应该被看作独立业务系统。这样看的时候，我们自然而然会有新的要求：如何让新功能的代码与既有系统解耦，能够不依赖尽量不依赖。

不依赖核心的含义是业务不依赖。新功能的绝大部分代码独立于既有业务系统，只有少量桥接的代码是耦合的。

实际上对于任何被正交分解的周边系统 B 与核心系统 A，理想情况我们最终得到的应该是三个模块：A、B（与 A 无关部分）、A 与 B 桥接代码（与 A 相关的部分）。虽然从归属来说，A 与 B 桥接代码我们通常也会放到 B 模块，但是它应该尽可能小，且尽可能独立于与核心系统无关的代码。

这就是做新功能的思路，尽可能与既有系统剥离，从独立业务视角去实现业务，抽象对环境的依赖。最后，用最少量的对接代码把整个系统串起来。



## 架构的局部优化

聊完添加新功能，我们谈谈局部调整。它的目标是优化某个功能与核心系统的耦合关系。它有两种常见做法：

- 一种是重写，或者叫局部重构。它相当于从系统中彻底移除掉与该功能相关的代码，重新写一份新的。这和开发一个新功能没什么两样，最多看看被移除的代码里面，有哪些函数设计比较合理，可以直接拿过来用，或者稍微重新包装一下能够让规格更合理的。
- 另一种是依赖优化。它关注的重心不是某项功能本身的实现，而是它与系统之间的关系。



## 核心系统的重构

确定要对核心系统进行重构，那么最高优先级是确定它的边界，也就是使用界面（接口）。能够在不修改实现的情况下调整核心系统的使用界面到我们期望的样子是最好的。

周边系统对核心系统的依赖无非两类：

- 一是核心系统的功能，表现为它提供的 DOM 接口；
- 二是核心系统提供的事件，让周边系统能够介入它的业务流程。