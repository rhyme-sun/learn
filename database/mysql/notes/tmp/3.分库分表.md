# 分库分表

## 总览

## MySQL 技术演进

![](../images/MySQL技术演进.png)

### 为什么要做数据拆分

单机的 MySQL 已经无法满足业务数据的增长，主要体现在以下两个方面：

- 性能方面：由于 MySQL 数据库使用 B+ 树结构存储索引，再数据量超过阈值的情况下，索引树深度增加会增加磁盘访问的 IO 次数，从而降低了数据库读取性能。同时，高并发的访问也使得集中单机式的数据库服务成为整个系统的瓶颈。
- 可用性方面：服务无状态化必然将服务的存储状态转移给数据库，集中式的单一节点出故障的爆炸半径会更大。从运维角度来看，一个数据库实例中的数据达到阈值以上，数据备份和恢复的时间成本都会更大。

```
Note
主从复制是否能解决这个容量问题？
主从结构实现了读取分离，分担了单个数据库的读写压力，但单机的数据容量不变，没有解决数据量过大的问题。
```

### 扩展立方体

系统扩展可划分为三个维度：

- X 轴：通过无差别的克隆服务，做集群和负载均衡。
  - 优点：扩展相对容易。
  - 缺点：无法解决单节点性能瓶颈问题和容量问题。
  - 场景：发展初期，业务复杂度低，需要快速增加系统容量。

- Y 轴：通过解耦业务不同功能，做业务拆分。
  - 优点：业务解耦，故障隔离。
  - 缺点：对代码改动大，成本相对较高。
  - 场景：业务复杂，代码耦合度高，团队规模变大。

- Z 轴：通过拆分不同数据扩展，做数据分片。

## 数据库扩展

### 数据库扩展立方体

- X 轴：主从复制
- Y 轴：业务数据分类，垂直分库分表，同一个库的表分类后到不同的库，或者将很多列的单表拆分成几张小的表。
- Z 轴：水平分库分表，即同一类业务数据分到不同的表或库中，但对业务层尽量透明。

### 数据库扩展方式

- 分区：分区并不是生成新的数据表，而是将表的数据均衡分摊到不同的硬盘，系统或是不同服务器存储介子中，实际上还是一张表。
- 分表：分表需要将原本的表进行列或行的拆分，并在数据库中真实的创建这些物理表。
- 分库：将库中的表分类拆分到不同的库中。

### 数据库垂直拆分

对应数据库扩展立方体的 Y 轴扩展。

- 垂直拆分库：将一个库拆分成不同业务数据处理能力的数据库。

- 垂直拆分表：如果单表数据量过大，列过多，需要将表拆分成力度更细的粒度的表，参考数据库第二范式。

- 垂直拆分的优点：
  - 单库（单表）变小，便于管理和维护。
  - 对性能和容量有提升作用。
  - 改造后，系统和数据复杂度降低。
  - 可以作为微服务改造的基础。
- 垂直拆分的缺点：
  - 库变多，管理变复杂。
  - 对业务系统有较强的侵入性。
  - 改造过程复杂，容易出故障。
  - 拆分到一定程度就无法继续拆分。

- 垂直拆分的一般做法
  - 梳理清楚拆分范围和影响范围。
  - 检查评估和重新影响到的服务。
  - 准备新的数据库集群复制数据。
  - 修改系统配置并发布新版上线。

```
垂直拆分，先拆分业务还是先拆分数据库？
// TODO ...
拆分前，从规划上先拆分业务，弄清楚业务拆分对现有系统的影响，评估和给出改造方案，然后根据业务拆分给出库和表的拆分方案。实际改造过程中，先创建好拆分的表和库，再基于拆分好的进行业务改造。改造完成测试，迁移以前的全量数据，流量切换。
```

### 数据库水平拆分

水平拆分就是直接对数据进行分片，有分表、分区和分库三个个具体方式，都可以降低单个节点数据量，不改变数据本身的结构。这样对业务系统本身的代码逻辑来说，就不需要做特别大的改动，甚至可以基于一些中间件做到透明。分库和分表一般需要我们自己或者借助于一些数据库中间件区实现，分区一般是数据库层面去实现的。

- 分表或分区的策略
  - 根据某列值的范围进行拆分，如时间范围和大小范围。
  - 根据某列值 Hash 之后按照分表或分区个数取模拆分。
  - 根据单独配置的分表和某列数据的映射关系进行拆分。

```
Note:
上述提到的某列，叫做分片键，是数据进行水平拆分的依据，对水平数据的查询通过分片键来查询可以快速定位到分片的位置，查询效率高。
```

- 水平拆分的优点：
  - 解决容量问题，这也是水平拆分的主要目的。
  - 比垂直拆分对系统影响小。
- 水平拆分的缺点：
  - 复杂SQL支持问题（业务侵入性、性能）。
  - 数据迁移问题。

```
Note
分库还是分表？
// TODO ...
```

## 数据分类管理

随着我们对业务系统、对数据本身的进一步了解，我们就会发现，很多数据对质量的要求是不同的。可根据数据访问频次将数据分为热数据、温数据和冷数据。

热数据

温数据

冷数据

// TODO ....

## 相关框架和中间件

- Java框架层面：
  - TDDL
  - Apache ShardingSphere-JDBC

- 中间件层面：
  - DRDS（商业闭源）
  - Apache ShardingSphere-Proxy
  - MyCat/DBLE
  - Cobar
  - Vitness
  - KingShard

## 数据迁移



## 总结

### 参考链接

[[1] 简书.AKF扩展立方体](https://www.jianshu.com/p/d08d0c14810f)

[[2] 腾讯云社区.数据库分区、分表、分库](https://cloud.tencent.com/developer/article/1486625)