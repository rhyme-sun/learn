# 创建多少线程合适

创建多少线程合适，要看多线程具体的应用场景。我们的程序一般都是 CPU 计算和 I/O 操作交叉执行的，由于 I/O 设备的速度相对于 CPU 来说都很慢，所以大部分情况下，I/O 操作执行的时间相对于 CPU 计算来说都非常长，这种场景我们一般都称为 **I/O 密集型计算**；和 I/O 密集型计算相对的就是 **CPU 密集型计算**了，CPU 密集型计算大部分场景下都是纯 CPU 计算。I/O 密集型程序和 CPU 密集型程序，计算最佳线程数的方法是不同的。

## CPU 和 I/O 设备综合利用率

要想“降低延迟，提高吞吐量”，对应的方法呢，基本上有两个方向，一个方向是**优化算法**，另一个方向是**压榨硬件性能**。前者属于算法范畴，后者则是和并发编程息息相关了。那计算机主要有哪些硬件呢？主要是两类：一个是 I/O，一个是 CPU。简言之，在并发编程领域，提升性能本质上就是提升硬件的利用率，再具体点来说，就是提升 I/O 的利用率和 CPU 的利用率。

操作系统不是已经解决了硬件的利用率问题，操作系统已经解决了磁盘和网卡的利用率问题，利用中断机制还能避免 CPU 轮询 I/O 状态，也提升了 CPU 的利用率。但是操作系统解决硬件利用率问题的对象往往是单一的硬件设备，而我们的并发程序，往往需要 CPU 和 I/O 设备相互配合工作，也就是说，我们需要解决 **CPU 和 I/O 设备综合利用率**的问题。

如何提解决 **CPU 和 I/O 设备综合利用率**的问题？

假设程序按照 CPU 计算和 I/O 操作交叉执行的方式运行，而且 CPU 计算和 I/O 操作的耗时是 1:1。

如果是单个线程，每次只能进行 I/O 操作或 CPU 计算，执行 CPU 计算时，I/O 设备会空闲下来，执行 I/O 操作时，CPU 会空闲下来，因为 CPU 计算和 I/O 操作的耗时是 1:1，所以此时 CPU 的利用率和 I/O 设备的利用率都是 50%。

那么我们如何解决上述 CPU 和 I/O 设备的利用率问题呢？答案时多线程。

我们可以使用两个个线程（A 和 B），当线程 A 执行 CPU 计算的时候，线程 B 执行 I/O 操作；当线程 A 执行 I/O 操作的时候，线程 B 执行 CPU 计算，这样 CPU 的利用率和 I/O 设备的利用率就都达到了 100%。

## CPU 密集型

对于 CPU 密集型计算，多线程本质上是提升多核 CPU 的利用率，所以对于一个 4 核的 CPU，每个核一个线程，理论上创建 4 个线程就可以了，再多创建线程也只是增加线程切换的成本。所以，对于 CPU 密集型的计算场景，理论上“线程的数量 =CPU 核数”就是最合适的。不过在工程上，线程的数量一般会设置为“CPU 核数 +1”，这样的话，当线程因为偶尔的内存页失效或其他原因导致阻塞时，这个额外的线程可以顶上，从而保证 CPU 的利用率。

## IO 密集型

对于 I/O 密集型的计算场景，比如前面我们的例子中，如果 CPU 计算和 I/O 操作的耗时是 1:1，那么 2 个线程是最合适的，两个线程交叉地去执行 CPU 操作和 IO 操操作，理论上来讲，CPU 和 IO 设备的利用率会达到 100%。如果 CPU 计算和 I/O 操作的耗时是 1:2，那多少个线程合适呢？是 3 个线程，如下图所示：CPU 在 A、B、C 三个线程之间切换，对于线程 A，当 CPU 从 B、C 切换回来时，线程 A 正好执行完 I/O 操作。这样 CPU 和 I/O 设备的利用率都达到了 100%。

我们会发现，对于 I/O 密集型计算场景，最佳的线程数是与程序中 CPU 计算和 I/O 操作的耗时比相关的，我们可以总结出这样一个公式：

```
最佳线程数 = 1 +（I/O 耗时 / CPU 耗时）
```

如果我们假设程序单次任务处理的总时间为 I/O 耗时 + CPU 耗时，上述公式也可以使用以下公式表示：

```
最佳线程数 = 总耗时 / CPU 耗时
```

不过上面这个公式是针对单核 CPU 的，至于多核 CPU，也很简单，只需要等比扩大就可以了，计算公式如下：

```
最佳线程数 = CPU 核数 * [ 1 + (I/O 耗时 / CPU 耗时)]

最佳线程数 = CPU 核数 * (总耗时 / CPU 耗时)
```

## 总结

很多人都知道线程数不是越多越好，但是设置多少是合适的，却又拿不定主意。其实只要把握住一条原则就可以了，这条原则就是将硬件的性能发挥到极致（让硬件不要停下来）。上面我们针对 CPU 密集型和 I/O 密集型计算场景都给出了理论上的最佳公式，这些公式背后的目标其实就是将硬件的性能发挥到极致。

对于 I/O 密集型计算场景，I/O 耗时和 CPU 耗时的比值是一个关键参数，不幸的是这个参数是未知的，而且是动态变化的，所以工程上，我们要估算这个参数，然后做各种不同场景下的压测来验证我们的估计。不过工程上，原则还是将硬件的性能发挥到极致，所以压测时，我们需要重点关注 CPU、I/O 设备的利用率和性能指标（响应时间、吞吐量）之间的关系。

以上内容总结自极客时间《Java并发编程实践》：

- [10 | Java线程（中）：创建多少线程才是合适的？ (geekbang.org)](https://time.geekbang.org/column/article/86666)