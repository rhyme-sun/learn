# 如何写好并发程序

在 Java 语言里，使用面向对象的思想会使得书写并发编程代码变得相对简单，代码编写可从**封装共享变量**、**识别共享变量间的约束条件**和**制定并发访问策略**这三个方面下手。

## 封装共享变量

封装是面向对象编程的四个特性之一，封装简单来讲就是将实现的细节封装到对象内部，对外暴露一些自然体现业务需求的接口，对内保护了数据，对外让接口变得易用。如果将封装的思想使用在并发编程上，就是封装对象内部共享变量的访问（避免共享变量“溢出”到对象外部），对外提供线程安全的改变共享变量状态的方法。

## 识别共享变量间的约束条件

识别共享变量间的约束条件非常重要。因为这些约束条件，决定了并发访问策略。

## 制定并发访问策略

制定并发访问策略，是一个非常复杂的事情，不过宏观上从方案来看，无外乎就是以下“三件事”：

- 避免共享：避免共享的技术主要是利于线程本地存储以及为每个任务分配独立的线程；
- 不变模式：这个在 Java 领域应用的很少，但在其他领域却有着广泛的应用，例如 Actor 模式、CSP 模式以及函数式编程的基础都是不变模式；
- 管程及其他同步工具：Java 领域万能的解决方案是管程，但是对于很多特定场景，使用 Java 并发包提供的读写锁、并发容器等同步工具会更好。

更加具体的原则有以下三条：

- 优先使用成熟的工具类：Java SDK 并发包里提供了丰富的工具类，基本上能满足你日常的需要，建议你熟悉它们，用好它们，而不是自己再“发明轮子”，毕竟并发工具类不是随随便便就能发明成功的。
- 迫不得已时才使用低级的同步原语：低级的同步原语主要指的是 synchronized、Lock、Semaphore 等，这些虽然感觉简单，但实际上并没那么简单，一定要小心使用。
- 避免过早优化：安全第一，并发程序首先要保证安全，出现性能瓶颈后再优化。在设计期和开发期，很多人经常会情不自禁地预估性能的瓶颈，并对此实施优化，但残酷的现实却是：性能瓶颈不是你想预估就能预估的。

## 总结

以上内容总结自于极客时间专栏《Java并发编程实践》：

- [12 | 如何用面向对象思想写好并发程序？-极客时间 (geekbang.org)](https://time.geekbang.org/column/article/87365)