# 活字格工作流

活字格工作流。

## 如何使用

[活字格V8.0 工作流教程（正式版） · 语雀 (yuque.com)](https://www.yuque.com/books/share/fa32d6c1-e303-4fcf-9557-2c5515f7278d?)

### 新老工作流的关系

8.0 版本的工作流和之前的工作流式不兼容的。如果用 8.0 的设计器打开旧版本的包含了旧版本工作流的工程文件，可以继续使用旧版本的工作流，但无法创建和使用新版本的工作流。

如果想在这个工程文件中使用新版本工作流，需要将老版本的工作流关闭，关闭老版本的工作流会导致老版本工作流历史信息丢失，工作流历史视图移除，并且无法恢复。

### 流程数据

流程数据库。

流程相关的表。

如果使用内建数据库，流程会额外创建一个 SQLite 数据库存放流程数据，和其他业务数据使用的是不同的内建库。在流程视图不能添加公式字段。

如果使用外联库，流程数据表和业务表在同一个数据库中。

### 流程辅助视图

[流程视图 - 活字格V8帮助手册 - 葡萄城产品文档中心 (grapecity.com.cn)](https://help.grapecity.com.cn/pages/viewpage.action?pageId=77495066)

流程辅助视图会设置一些默认的行权限，控制流程数据的展示。



流程定义视图

一行记录对应设计器中创建的每个流程，被绑定到内置的流程列表页面，在发起流程时供用户选择需要发起哪个流程。



流程实例视图

已发起的，在运行的流程。

行权限，登录用户可以看到自己发起的流程实例，流程的参与者可以看到所有记录。

流程实例将所有的内容串联。



全部任务视图（我的已办页面）

所有进行的任务。



运行任务视图（我的待办页面）



审批记录视图（审批记录页面）



**任务视图会影响到绑定业务表的当前行。如果将任务视图和业务表绑定到同一个页面，可能会造成业务表的当前行出现预期之外的结果。**

### 流程辅助页面

流程辅助页面在首次创建流程时会自动创建，组成了内置的流程中心。

[流程页面 - 活字格V8帮助手册 - 葡萄城产品文档中心 (grapecity.com.cn)](https://help.grapecity.com.cn/pages/viewpage.action?pageId=74285636)

我的待办，任务负责人是当前登录用户的运行任务。





### 流程元素

[流程元素 - 活字格V8帮助手册 - 葡萄城产品文档中心 (grapecity.com.cn)](https://help.grapecity.com.cn/pages/viewpage.action?pageId=72369047)



开始节点

结束节点



分流合流

[什么是BPMN网关？ -解道Jdon](https://www.jdon.com/workflow/gateway.html)

包容网关：分流时，所有满足条件的后续分支都会执行。合流时，之前的所有分支流入后才会通过。

排他网关：分流时，只有满足条件的第一个后续分支会执行。合流时，在任何分支流入后都会直接通过。

人工节点

连线



### 节点操作

操作类型：

提交/同意

结束

回退

调度

暂存

自定义



### 用户设置

选择当前节点的负责人。

用户选人

自动选人



自动通过规则：

- 负责人就是发起人；
- 负责人已经参与过；
- 负责人和上一步相同。



### 条件设置

连线设置条件。





### 事件设置

流程事件。

流程启动时

流程完成时

流程取消时



节点事件

节点进入时

任务创建时

任务取消时

任务完成是

节点离开时

无负责人时





### 流程命令



前端命令

发起流程，通过流程定义 ID 或名称发起流程。

打开流程在线设计器，在线编辑流程。





后端命令

发起流程。

管理流程定义：管理流程定义的状态（挂起、激活、删除）。

先挂起流程，再修改流程定义。



管理流程实例

挂起、激活、取消、删除、更新流程实例名称。



管理流程任务

流转任务到其他节点。



流程命令用于从业务页面发起、操作流程。而不是流程中心（流程辅助页面）发起。

### 流程变量

全局变量

局部变量



设置条件和设置负责人时可以用到设置的变量。

### 流程权限

流程编辑权限。

右键流程定义，选择流程编辑权限，控制流程在线编辑的权限。



流程运行权限。

流程属性全局设置，设置流程发起权限。



### 发布流程

每次发布自动生成版本。









## 实战练习

[高级课程：2 小时玩转活字格工作流 - 活字格专区 - 专题教程 - 葡萄城产品技术社区 (grapecity.com.cn)](https://gcdn.grapecity.com.cn/forum.php?mod=viewthread&tid=151216)

默认生成流程中心页面，可以对流程集中进行管理。

工作流和活字格内部组织机构。



流程节点跳转的方向通过连线来描述，但其并不能完全代表流程运行时节点间的跳转方式。实际流程运行过程中，用户的操作（流程命令条）决定了节点的跳转规则：

节点操作的行为类型包括：提交、结束、回退、调度、暂存和自定义。

- 提交：让将流程从当前节点流向下一个节点。通常，填单时叫做提交，审批时叫做批准或同意。
- 结束：结束类型，包括结束当前分支的任务和结束整个流程两种。由于网关产生多个分支时，结束当前分支的任务只会结束其中一个分支，结束整个流程会结束所有分支的任务。
- 回退：回退流程到指定节点。包括回退到上一节点、回退到开始节点、回退到来源节点。
- 调度：可以将流程转移到任意节点。
- 暂存：当前页面的业务数据将被存储到数据库中。仅用于保存业务数据，不会流转流程。
- 自定义：是一个纯粹的面向自定义业务的按钮。通常在流程命令条的前置或后置事件中执行自定义业务逻辑，比如调用导出页面命令。



流程相关相关权限设置。

流程定义级别：发起流程、编辑流程定义（仅在控制台配置）；

节点级：数据权限（通常用于相关页面的开发），控制节点的负责人能够看到那些权限；不同的节点不同的负责人看到不同的数据，通过数据权限控制页面交互体验，通常用于要求较低的简单业务。



任务派发机制：进入节点创建任务 -> 框选出候选人的范围（负责人） -> 决定为哪些/个负责人派发任务（处理策略） -> 派发时，引擎会自动生成工作流任务。



任务（节点）负责人：谁来处理这个节点对应任务。



多个负责人和没有负责人的处理策略。





内置找人（框选指定人的范围）：3 + 1 种模式。

按用户：指定对应用户为负责人，用户可以来自于内置的用户、数据表的字段、关键字、或变量。自定义属性（用户管理创建的自定义属性）

按角色：指定对应角色的用户为负责人

按组织机构（可选：组织机构 + 角色）：指定对应组织下的用户为负责人。常见应用比如，指定我所在的组织机构的负责人为任务负责人。





自定义找人。

自定义找人，2 种实现：

通过关联的业务数据指定，在业务数据指定当前记录的负责人。

在“节点进入事件”中，通过服务端命令 + 参数指定。



处理策略

多个负责人任务任务审批方式：会签（找到的符合条件的负责人都同意才算通过）和抢签（找到符合条件的人只要有一个同意才算通过）。

无负责人/其他条件：自动通过。

人员范围：

- 用户选择一人（由上级节点的用户选择一人）

- ...



流程事件：流程运行时自动执行某些操作。





发起和执行流程：流程设计好后，如何使用工作流。



工作流和业务页面的分工。

一个业务数据和一个工作实例 1 对 1，一个工作实例对应多个工作流任务，一个工作流任务对应多个工作流操作。





流程发起命令，流程命令条，流程操作命令。



流程发起命令——流程发起的两种方案。

基于业务数据发起流程：一个很重要的特点是第一个人工节点是审批/处理节点。

从零发起流程：第一个人工节点时数据填报节点。





流程发起命令——基于业务数据发起流程的执行过程：

- 从流程定义创建流程实例；
- 将业务数据绑定到流程实例；
- 进入开始节点。



流程发起命令——从零发起流程命令执行过程：

- 从流程定义创建流程实例；
- 进入开始节点。







流程命令条用来驱动和响应用户操作。

命令条上的按钮类型和当前任务有关，即当前这个任务它可以有哪些操作。这些操作类型的控制因素有两个，一个是人工节点的设置，另外一个是这些操作类型所设置的过滤条件。

流程命令条绑定了当前任务。



流程命令条工作原理：

- 引擎会根据当前任务对应节点的设计，展示必要的操作；
- 用户点击操作按钮后，引擎自动执行前置命令；
- 引擎自动执行流程对应操作，触发对应事件，完成后，执行后置命令。













### 业务数据管理新版流程

[一看就会，超有用活字格技能：一百五十一、业务数据关联新版流程 - 活字格专区 - 专题教程 - 葡萄城产品技术社区 (grapecity.com.cn)](https://gcdn.grapecity.com.cn/forum.php?mod=viewthread&tid=150241&fromuid=64322)



























[高级课程：2 小时玩转活字格工作流 - 活字格专区 - 专题教程 - 葡萄城产品技术社区 (grapecity.com.cn)](https://gcdn.grapecity.com.cn/forum.php?mod=viewthread&tid=151216)



流程概念

流程定义：流程设计器中设计好的一个流程，表示流程的元信息。

流程实例：通过流程定义发起流程，就会创建出一个流程实例，是流程定义运行时的概念。

流程任务：流程运转的每个环节，**一个流程节点可能会对应多个任务，这一般会取决于节点的负责人个数**。









业务过程中的部分或整体在计算机应用环境下的自动化。



工作流是概念（机制），工作流引擎是实现，BPMN 是框架标准。

基于 BPMN 构建的工作流引擎可以有效地加速工作流的开发与交付。









工作流生命周期

![](../images/工作流.png)

工作流适用场景：

- 流程中多个人为审批操作
- 开发者需要调整工作交付给系统管理员
- 对流程中的操作进行记录分析的需求





工作流概念

![](../images/工作流架构.png)

工作流定义与实例

工作流相当于一个模板，基于模板的定义运行起来的就是工作流实例。











事件与节点

节点：用来描述人工或自动操作。

- 负责人/权限：候选的操作人
- 操作：控制节点流向
- 事件：**触发业务操作**

分流/合流 + 连线：预设节点流向，完成分支判断。



工作流、数据与页面

![](../images/工作流与页面.png)





工作流常见的开发方式

绘制流程图

定制和绑定业务数据表和页面

定义和绑定事件（服务端命令）



工作流相关的用户、角色、组织机构的管理





工作流的维护方式

开发阶段在设计器上维护

系统管理员在线维护工作流







## 绘制流程图

工作流设计器

节点与连线配置

流程相关权限控制



工作流连接外联库创建工作流相关的表。

会创建 25 张表，5 个视图。



到达流程某个节点后用户的**操作**决定了节点的跳转规则：

- 提交/同意：完成，并按照连线跳转到下一个节点，如果涉及分流/合流，按照连线条件选择对应的连线；
- 回退：取消，按照设定的规则，回溯到特定的节点；
- 调度：取消，并跳转到特定节点（按照节点名称进行跳转）；
- 暂存/自定义：保持当前节点，不进行跳转；
- 结束：取消，直接跳转到结束节点。



交互页面：关联页面、数据权限、流程命令条；

负责人：圈定负责人的范围，人员选择和处理策略。

通知：任务创建通知，超时通知；





网关：

分流合流就像现实中的江流一样，有主干河流和分支河流，河流会分叉也会合并。

通过分流合流，可以实现复杂的业务逻辑审批、工作处理，提高流程效率，提高多部门的协同办公的能力。

分流合流有两种网关类型，其中，排他网关主要用于条件分支，包容网关除了条件判断，还具有并行分支的能力，适用于多人，多部门相互独立审批工作、处理工作。

包容网关

- 分流：所有满足条件或没有条件的后续分支都会执行。
- 合流：之前的所有分支全部流入后才会通过。

排他网关：

- 分流：只有满足条件的第一个后续分支会执行。

  当流程执行到这个网关时，所有分支都会判断条件是否为 true，如果为 true 则执行该分支。

  注意：排他网关只会选择一个为 true 的分支执行。(即使有两个分支条件都为 true，排他网关也会只选择最先定义的条件分支去执行。

- 合流：任何分支流入后都会直接通过。

  

网关策略

- 人工节点可以同时连入或连出多条线，所以它是一个隐含网关。下方图中的两个流程是完全等价的。
- 人工节点多条线连出时，遵循包容网关策略，即条件为 true，所有的分支都会执行。
- 人工节点多条线连入时，遵循排他网关策略，即任何分支流入后都会直接通过。



网关有多条流出的连线时，会按照连线的顺序依次判断条件。在网关的“常规设置”→“分支条件排序”设置列表中，您可通过拖动排序分支条件。





节点：

人工节点

节点的操作：

- 节点操作的行为类型包括：提交、结束、回退、调度、暂存和自定义。
  - 提交：让将流程从当前节点流向下一个节点。通常，填单时叫做提交，审批时叫做批准或同意。
  - 结束：结束类型，包括结束当前分支的任务和结束整个流程两种。由于网关产生多个分支时，结束当前分支的任务只会结束其中一个分支，结束整个流程会结束所有分支的任务。
  - 回退：回退流程到指定节点。包括回退到上一节点、回退到开始节点、回退到来源节点。
  - 调度：可以将流程转移到任意节点。
  - 暂存：当前页面的业务数据将被存储到数据库中。仅用于保存业务数据，不会流转流程。
  - 自定义：是一个纯粹的面向自定义业务的按钮。通常在流程命令条的前置或后置事件中执行自定义业务逻辑，比如调用导出页面命令。
- 操作名称：设置节点操作的名称。
- 执行操作前保存业务数据：是否在操作前保存页面上的业务数据。默认不勾选此项。
- 显示备注输入框：是否显示备注输入框。勾选后，负责人在处理任务时，可通过输入框录入审批意见。
- 显示操作的条件：设置显示节点操作的过滤条件。



## 流程权限设置

流程定义级别：发起流程、编辑流程定义（仅在控制台配置）；

节点级：数据权限（通常用于相关页面的开发）；

通过数据权限控制页面交互体验，通常用于要求较低的简单业务。



## 负责人

![image-20220822110826463](C:\Users\simonsun\AppData\Roaming\Typora\typora-user-images\image-20220822110826463.png)



任务派发机制

![image-20220809162519381](../images/任务派发机制.png)



自定义找人策略

内置找人策略，与活字格的角色与组织结构。

3 + 1 种模式。

按用户

按角色

按组织机构（可选：组织机构 + 角色）



自定义找人，2 种实现：

通过关联的业务数据指定

在“节点进入事件”中，通过服务端命令 + 参数指定。



处理策略

根据找到人负责人的情况设置处理策略。

会签与抢签

会签：找到的符合条件的负责人都同意才算通过

抢签：找到符合条件的人只要有一个同意才算通过

自动通过：没找到有负责人/其他条件

人员范围：有多个负责人时该如何处理？

- 由用户选择：上一步节点的用户选择（人工节点上有三条杠表示系统判断这个节点会有多个负责人）







## 自定义事件



[高级课程：2小时玩转活字格工作流 - 活字格专区 - 专题教程 - 葡萄城产品技术社区 (grapecity.com.cn)](https://gcdn.grapecity.com.cn/forum.php?mod=viewthread&tid=151216)  第七节

```
开始 -> 填单 -> 审批 -> 结束
```



![image-20220822111103927](C:\Users\simonsun\AppData\Roaming\Typora\typora-user-images\image-20220822111103927.png)

活字格事件类型：

流程启动时

开始节点离开时

[填单]节点进入时

任务创建时

任务完成时

节点离开时



任务取消时

流程取消时

流程完成时





![image-20220810092816271](E:\DevProjects\LearnProjects\learn\programing-language\low-code\huozige\images\节点事件-1.png)

![image-20220810093042003](E:\DevProjects\LearnProjects\learn\programing-language\low-code\huozige\images\节点事件2.png)



事件的处理方式

![image-20220810093341766](E:\DevProjects\LearnProjects\learn\programing-language\low-code\huozige\images\事件的处理方式.png)

使用场景：

- 自定义选人：人工节点—节点进入时

  设置负责人选人逻辑

-  代办提醒通知：人工节点—任务创建时

- 会写业务数据：结束节点—节点进入时

## 流程命令

[流程命令 - 活字格V8帮助手册 - 葡萄城产品文档中心 (grapecity.com.cn)](https://help.grapecity.com.cn/pages/viewpage.action?pageId=73236763)

在流程中可以使用命令，通过命令来控制流程的流转，发送通知等。

您可以在流程设计器中设置命令。设置命令的位置包括：

- 流程属性设置的高级设置中的事件：流程启动时、流程完成时、流程取消时。
- 人工节点的高级设置中的事件：任务创建时、任务完成时、任务取消时、节点进入时、节点离开时和无负责人时。
- 连线的高级设置中的事件：连线经过时。
- 开始或结束节点的高级设置中的事件：节点离开时/节点进入时。
- 超时设置中的超时操作可设置命令。



您可以通过设置变量命令定义上下文变量或全局变量（流程属性中创建的变量）。

命令需设置变量名和变量值。变量名可以自己定义，也可以选择全局变量。



## 发起和执行流程

以上章节介绍了工作流如何创建，这个章节介绍工作流如何使用，如何和业务功能集成。



工作流和业务页面分工

![image-20220810094505872](E:\DevProjects\LearnProjects\learn\programing-language\low-code\huozige\images\工作流与业务数据关系.png)



![image-20220810094655447](C:\Users\simonsun\AppData\Roaming\Typora\typora-user-images\image-20220810094655447.png)

工作流和页面的交互基于任务，而不是业务数据

工作流页面中可嵌入业务页面，提供额外的数据交互能力

工作流可以嵌入业务流程，也可以独立运行









流程发起命令-发起流程的两种方案

- 基于业务数据发起流程：第一个人工节点是审批/处理节点。

  起始过程：

  从流程定义创建流程实例

  将业务数据绑定到流程实例

  进入开始节点

- 从零开始发起流程：第一个人工节点是数据填报节点。

  起始过程：

  从流程定义创建流程实例

  直接进入开始节点

这两种方案提供了不同的交互体验，前者类似于业务系统，后者类似于 OA。





流程条

流程操作命令





## 分析流程数据

流程视图

![image-20220810100951778](E:\DevProjects\LearnProjects\learn\programing-language\low-code\huozige\images\流程数据视图.png)



使用场景：

流程效率：流程实例视图的持续时间

环节效率：全部任务视图的持续时间（按流程实例 ID + 名称）过滤

员工效率：全部任务视图的持续时间（按流程实例 ID + 名称 + 负责人）过滤





## 持续学习

**作流的数据表应该放在内置库还是外联库？**
考虑到性能和可靠性，除非临时使用的应用场景，或验证用原型，我们推荐您使用外联库存储业务数据和工作流数据。如需将工作流相关的数据表建立在外联库，请先添加连接信息（[帮助文档](https://help.grapecity.com.cn/pages/viewpage.action?pageId=72355289)）。

**做工作流应用时，应该先画流程图还是先做页面？**
这是一个工作习惯问题，怎么做都是可以的。我们推荐的做法如下：如果工作流仅用于记录操作的顺序和时间，就像第二节课中演示的维修现场登记流程，可以直接画流程图，而无需页面和数据表。如果是常规的业务审批流程，推荐您先基于审批的单据建立数据表、表关联，然后构建将审批结果回写到单据的服务端命令（第七节），之后再画流程图（第五节），如涉及自定义选人或自定义事件，可以参照第六节和第七节的做法，构建配套的服务端命令。流程图绘制完毕后，再分析每个人工节点，根据用户体验的精细化要求，对节点的页面进行合并，然后再做对应的页面。
